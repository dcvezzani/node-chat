<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>

  <style>
    #makeMeDraggable { width: 300px; height: 300px; background: red; }
    #game-board { position: relative; height: 800px; width: 800px; background-color: blue; margin: 0 auto; }
    #canvas { display: table; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid orange; }
    .middle { position: relative; display: table-cell; vertical-align: middle; }
    .snap-point { display: block; position: absolute; width:10px; height:10px; background-color: yellow; border: 1px solid black; }
    #msg { border: 1px solid orange; width: 100%; display: block; min-height: 2em;}
    .moving { opacity: 0.5; background-color: green; }
  </style>  
  
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>

  <script type="text/javascript">
   
  $( init );
   
  function checkLeftTop(draggable, droppable, offset){
    return ((draggable.left > (droppable.left + offset.left)) && (draggable.left < (droppable.left + offset.left + droppable.width)) && (draggable.top > (droppable.top + offset.top)) && (draggable.top < ((droppable.top + offset.top) + droppable.height)));
  }

  function checkRightTop(draggable, droppable, offset){
    // $('#msg ul').append("<li>" + JSON.stringify(
    //   "" + (draggable.left + draggable.width) + " > " + (droppable.left + offset.left) + " && " + (draggable.left + draggable.width) + " < " + (droppable.left + offset.left + droppable.width) + " &&  " + draggable.top + " > " + (droppable.top + offset.top) + " && " + draggable.top + " < " + ((droppable.top + offset.top) + droppable.height)
    // ) + ": checkRightTop<\/li>")
    return (((draggable.left + draggable.width) > (droppable.left + offset.left)) && ((draggable.left + draggable.width) < (droppable.left + offset.left + droppable.width)) && (draggable.top > (droppable.top + offset.top)) && (draggable.top < ((droppable.top + offset.top) + droppable.height)));
  }

  function checkRightBottom(draggable, droppable, offset){
    return (((draggable.left + draggable.width) > (droppable.left + offset.left)) && ((draggable.left + draggable.width) < (droppable.left + offset.left + droppable.width)) && ((draggable.top + draggable.height) > (droppable.top + offset.top)) && ((draggable.top + draggable.height) < ((droppable.top + offset.top) + droppable.height)));
  }

  function checkLeftBottom(draggable, droppable, offset){
    return ((draggable.left > (droppable.left + offset.left)) && (draggable.left < (droppable.left + offset.left + droppable.width)) && ((draggable.top + draggable.height) > (droppable.top + offset.top)) && ((draggable.top + draggable.height) < ((droppable.top + offset.top) + droppable.height)));
  }

  function init() {
    $('#makeMeDraggable').draggable({
      cursorAt: { left: 150, top: 150 }, 
      opacity: 0.5
    });

    $('#game-board').droppable({
      accept: function(item){ return true }, 

      drop: function(event, ui) {
        var $this = $(this);
        if( $('#msg ul').length > 0 ){ $('#msg ul').remove(); }
        $('#msg').append("<ul><\/ul>")

        var draggable_obj = $(ui.draggable)
        var draggable_pos = $(draggable_obj).position();
        var draggable_snap_point = $(draggable_obj).find('.snap-point')
        var draggable_snap_point_pos = $(draggable_snap_point).position()

        draggable_pos = {top: Math.round(draggable_pos.top), left: Math.round(draggable_pos.left)};
        draggable_snap_point_pos = {top: Math.round(draggable_snap_point_pos.top), left: Math.round(draggable_snap_point_pos.left)};

        $('#msg ul').append("<li>" + JSON.stringify(draggable_pos) + ": draggable<\/li>")
        $('#msg ul').append("<li>" + JSON.stringify(draggable_snap_point_pos) + ": draggable snap point<\/li>")

        draggable_pos.left += draggable_snap_point_pos.left;
        draggable_pos.top += draggable_snap_point_pos.top;
        draggable_pos.width = $(draggable_snap_point).width();
        draggable_pos.height = $(draggable_snap_point).height();
        draggable_pos.bottom = draggable_pos.top + draggable_pos.height;
        draggable_pos.right = draggable_pos.left + draggable_pos.width;
          $('#msg ul').append("<li>" + JSON.stringify(draggable_pos) + ": draggable final<\/li>")

        var gameBoardOffset = {top: $this[0].offsetTop, left: $this[0].offsetLeft};
          $('#msg ul').append("<li>" + JSON.stringify(gameBoardOffset) + ": gameboard offset<\/li>");

        for(var i = 0; i < snapPoints.length; i++){
          var snapPoint = snapPoints[i]
          snapPoint.width = $("#makeMeDraggable").find('.snap-point').width();
          snapPoint.height = $("#makeMeDraggable").find('.snap-point').height();

          if(checkLeftTop(draggable_pos, snapPoint, gameBoardOffset) 
            || checkRightTop(draggable_pos, snapPoint, gameBoardOffset) 
            || checkRightBottom(draggable_pos, snapPoint, gameBoardOffset) 
            || checkLeftBottom(draggable_pos, snapPoint, gameBoardOffset)){

            var droppable_info = '#snap-point-' + snapPoint.left + '-' + snapPoint.top

            $( draggable_obj ).position({ my: "center", at: "center", of: droppable_info, 
              using: function(pos) { $(this).animate(pos, 200, "linear"); }
            });

            break;
          }
        }
        $('#msg ul').prepend("<li>DONE<\/li>")
      }
    });
  }
  </script>  
</head>

<body>
  
  <div id="canvas">
    <div class="middle">
      <div id="game-board"></div>
    </div>
  </div>
  
  <div id="content" style="height: 400px;">
    <div id="makeMeDraggable">
      
    </div>
  </div>
  
  <div id="msg"></div>
  
  <script>
    function createSnapPoint(selector, x, y){
      $(selector).first().append('<div id="snap-point-' + x + '-' + y + '" class="snap-point" style="top: ' + y + 'px; left: ' + x + 'px; "></div>');
    }

    var snapPoints = []

    $(document).ready(function(){
      for(var i=0; i < 800; i+=20){
        for(var j=0; j < 800; j+=20){
          createSnapPoint('#game-board', i, j);
          snapPoints.push({top: j, left: i})
        }
      }

      createSnapPoint('#makeMeDraggable', 145, 145);
      console.log('hiii');
    });
  </script>
</body>
</html>
